<?php
// =====================================================================
// ãƒ—ãƒ­ã‚»ã‚¹ 'toot-daily-qiita-items'
// =====================================================================
// å®šæ™‚ã”ã¨ï¼ˆï¼‘æ™‚é–“ãŠãï¼‰ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«æ–°ç€ Qiita è¨˜äº‹ã‚’ãƒˆã‚¥ãƒ¼ãƒˆã—ã¦ã„ãã€‚
//
// â– å®šæ™‚ã®åˆå›ãƒˆã‚¥ãƒ¼ãƒˆã®å ´åˆ
// 1) å‰ã‚¹ãƒ¬ãƒƒãƒ‰ã§ãƒˆã‚¥ãƒ¼ãƒˆã•ã‚ŒãŸã‚¿ã‚°ä¸€è¦§ã‚’è¨˜è¼‰ã—ãŸã€Œå–ã‚Šã¾ã¨ã‚ã€ã‚’ãƒˆã‚¥ãƒ¼ãƒˆ
// 2) æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹ã™ã‚‹æ—¨ã®ã€Œå®£è¨€ãƒˆã‚¥ãƒ¼ãƒˆã€ã‚’ãƒˆã‚¥ãƒ¼ãƒˆ
//    â€»ã„ãšã‚Œã‚‚ã€Œå…¬é–‹ã€ã§ãƒˆã‚¥ãƒ¼ãƒˆï¼ˆDEVç’°å¢ƒã®å ´åˆã¯ã€Œæœªåè¼‰ã€ï¼‰
//
// â– å®šæ™‚å†…ã®ãƒˆã‚¥ãƒ¼ãƒˆã®å ´åˆ
// 1) å‰ã®ãƒˆã‚¥ãƒ¼ãƒˆã«è¿”ä¿¡ã§æ–°ç€Qiitaè¨˜äº‹ã‚’ãƒˆã‚¥ãƒ¼ãƒˆã—ã¦ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã—ã¦ã„ã
//   - Qiitaè¨˜äº‹ãŒ Qiitadon ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨˜äº‹ã®å ´åˆã¯ã€Œæœªåè¼‰ã€ã§ãƒˆã‚¥ãƒ¼ãƒˆ
//   - ãã‚Œä»¥å¤–ã¯ã€Œéå…¬é–‹ã€ï¼ˆãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®ã¿é–²è¦§å¯ï¼‰ã§ãƒˆã‚¥ãƒ¼ãƒˆ
//   - ã€Œéå…¬é–‹ã€ãƒˆã‚¥ãƒ¼ãƒˆã¯ Boostoot ã§ãã‚‹ã‚ˆã†ã«ãƒˆã‚¥ãƒ¼ãƒˆç”¨ãƒªãƒ³ã‚¯ãŒä»˜åŠ 
//
// DEVç’°å¢ƒã®å‹•ä½œç¢ºèªç”¨ãƒªãƒ³ã‚¯
// https://blog.keinos.com/qithub_dev/?process=toot-daily-qiita-items&mode=debug

// åˆæœŸåŒ–
$result_toot      = TOOT_FAIL;
$is_new_toot      = false;
$id_toot_current  = ''; // ï¼‘ã¤å‰ã®ãƒˆã‚¥ãƒ¼ãƒˆID
$id_toot_original = ''; // è¦ªã®ãƒˆã‚¥ãƒ¼ãƒˆID
$max_items        = 10; // å–å¾—ã™ã‚‹Qiitaè¨˜äº‹ã®æ•°

// å–å¾—ï¼šãƒˆã‚¥ãƒ¼ãƒˆã«å¿…è¦ãªAPI
$keys_api     = get_api_keys('../../qithub.conf.json', 'qiitadon');
$domain       = $keys_api['domain'];
$access_token = ACCESS_TOKEN_MASTODON;

// èª­ã¿è¾¼ã¿ï¼šæœ€å¾Œã®ãƒˆã‚¥ãƒ¼ãƒˆIDã¨ç¾åœ¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®è¦ªãƒˆã‚¥ãƒ¼ãƒˆID
$id_data_toot = 'toot_id_and_date_of_daily_toot';
$info_toot    = load_data($id_data_toot);

// èª­ã¿è¾¼ã¿ï¼šæ–°ç€Qiitaè¨˜äº‹IDä¸€è¦§ï¼ˆãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ï¼‰
$id_data_qiita   = 'qiita_id_tooted';
$qiita_items_old = load_data($id_data_qiita);
$qiita_items_old = ( LOAD_DATA_EMPTY == $qiita_items_old ) ? array() : $qiita_items_old;

// èª­ã¿è¾¼ã¿ï¼šã‚¿ã‚°ä¸€è¦§ï¼ˆãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ï¼‰
$id_data_tags     = 'tag_list_of_daily_toot';
$list_tags_tooted = load_data($id_data_tags);
$list_tags_tooted = ( LOAD_DATA_EMPTY == $list_tags_tooted ) ? array() : $list_tags_tooted;

// å‰Šé™¤ï¼šå‹•ä½œç¢ºèªç”¨ã®è¦ç´ ã®å‰Šé™¤
//unset($qiita_items_old['9412acb2a7ff37ff9ad0']);

// æ¯”è¼ƒãƒ»å·®åˆ†å–å¾—ï¼šæœ€æ–°ã®æ–°ç€Qiitaè¨˜äº‹ã®å–å¾—ã¨ãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿è¨˜äº‹ã¨ã®æ¯”è¼ƒ
$result_api = run_script(
    'system/get-qiita-new-items',
    ['max_items' => $max_items],
    RUN_FOREGROUND
);
$qiita_items_new  = decode_api_to_array($result_api)['value'];
$qiita_items_diff = array_diff_key($qiita_items_new, $qiita_items_old);

// å–å¾—ï¼šç¾åœ¨ã®æ™‚é–“ï¼ˆYmdHï¼‰ã‚’ã‚¹ãƒ¬ãƒƒãƒ‰ã®IDã¨ã—ã¦å–å¾—ï¼ˆï¼‘æ™‚é–“æ¯ã®ã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰
$id_thread = date('Y/m/d H:00');
echo_on_debug($id_thread, 'Current Thread ID');

// ãƒ•ãƒ©ã‚°è¨­å®šï¼šå®£è¨€ãƒˆã‚¥ãƒ¼ãƒˆãŒç™ºå‹•æ¸ˆã¿ã‹
// ç™ºå‹•æ¸ˆã¿ã®å ´åˆï¼šè¦ªãƒˆã‚¥ãƒ¼ãƒˆã¨æœ€æ–°ï¼ˆï¼‘ã¤å‰ã®ï¼‰ãƒˆã‚¥ãƒ¼ãƒˆã‚’ã‚»ãƒƒãƒˆ
if (LOAD_DATA_EMPTY !== $info_toot) {
    // ãƒˆã‚¥ãƒ¼ãƒˆIDã®å–å¾—
    $id_toot_original = trim($info_toot['id_toot_original']);
    $id_toot_current  = trim($info_toot['id_toot_current']);

    // å®£è¨€ãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
    if ($info_toot['id_thread'] !== $id_thread) {
        $is_new_toot = true;
    } elseif (! empty($id_toot_original) && ! empty($id_toot_current)) {
        $is_new_toot = false;
    } elseif (empty($id_toot_original) && empty($id_toot_current)) {
        $is_new_toot = true;
    } elseif (! empty($id_toot_original) && empty($id_toot_current)) {
        $id_toot_current = $id_toot_original;
        $is_new_toot = false;
    }
} else {
    $is_new_toot = true;
    echo_on_debug('æ–°è¦ãƒˆã‚¥ãƒ¼ãƒˆã®ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
}

// ---------------------------------------------------------------------
//  ã€Œå–ã‚Šã¾ã¨ã‚ã€ãƒˆã‚¥ãƒ¼ãƒˆ ã¨ å®£è¨€ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ã®è¦ª)ãƒˆã‚¥ãƒ¼ãƒˆ
// ---------------------------------------------------------------------
// ã¨ã‚Šã¾ã¨ã‚ï¼ˆå‰å›ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ä¸€è¦§ï¼‰ã‚’ãƒˆã‚¥ãƒ¼ãƒˆã—ãŸã®ã¡ã€æ¬¡
// ã®æ–°ç€Qiitaè¨˜äº‹ãƒˆã‚¥ãƒ¼ãƒˆã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹ã™ã‚‹å®£è¨€ãƒˆã‚¥ãƒ¼ãƒˆï¼ˆï¼ã‚¹ãƒ¬ãƒƒãƒ‰ã®
// è¦ªãƒˆã‚¥ãƒ¼ãƒˆï¼‰ã‚’è¡Œã†ã€‚
//
if ($is_new_toot) {
    // -----------------------------------------------------------------
    //   å®£è¨€å‰ã®ã€Œå–ã‚Šã¾ã¨ã‚ã€ãƒˆã‚¥ãƒ¼ãƒˆ
    // -----------------------------------------------------------------
    if (! empty($list_tags_tooted) && ! empty($id_toot_original)) {
        // ã‚¹ãƒ¬ãƒƒãƒ‰ã®æœ€çµ‚ãƒˆã‚¥ãƒ¼ãƒˆID
        $id_thread_last = $info_toot['id_thread'];

        // å–å¾—ï¼šå–ã‚Šã¾ã¨ã‚æ™‚åˆ»
        $thread_date  = date("Y/m/d", strtotime($id_thread_last));
        $thread_hour  = date("H æ™‚", strtotime($id_thread_last));

        // CWæ–‡
        // -------------------------------------------------------------
        $spoiler_text =<<<EOD
ğŸ“‹ã€â€‹:qiita:â€‹ã®ã‚¿ã‚°ä¸€è¦§ã€‘(${thread_date} ${thread_hour})
EOD;
        // ãƒ˜ãƒƒãƒ€ãƒ¼æ–‡
        // -------------------------------------------------------------
        $msg_header =<<<EOD
ä»¥ä¸‹ã®ã‚¿ã‚°ã®è¨˜äº‹ãŒã“ã®ï¼‘æ™‚é–“ã« :qiita: ã«æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸã€‚
â–â–â–â–â–â–â–â–â–â–
EOD;
        // ãƒ•ãƒƒã‚¿ãƒ¼æ–‡
        // -------------------------------------------------------------
        $msg_footer =<<<EOD
â–â–â–â–â–â–â–â–â–â–
ã“ã‚Œã‚‰ã®ã‚¿ã‚°ã‚’å«ã‚€è¨˜äº‹ã¸ã®ãƒªãƒ³ã‚¯ã¯ã€ã“ã®ãƒˆã‚¥ãƒ¼ãƒˆã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã€Œéå…¬é–‹ã€ã‚‚ã—ãã¯ã€Œæœªåè¼‰ã€ã§ãƒˆã‚¥ãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚
EOD;

        // ãƒšã‚¤ãƒ³ï¼ˆCWã€ãƒ˜ãƒƒãƒ€ãƒ¼ã€ãƒ•ãƒƒã‚¿ãƒ¼ï¼‰ã®æ–‡å­—æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        $count_char_pane  = mb_strlen($spoiler_text); // CWæ–‡ã®ã¶ã‚“
        $count_char_pane += mb_strlen($msg_header);   // ãƒ˜ãƒƒãƒ€ãƒ¼æ–‡ã®ã¶ã‚“
        $count_char_pane += mb_strlen($msg_footer);   // ãƒ•ãƒƒã‚¿ãƒ¼æ–‡ã®ã¶ã‚“
        $count_char_pane += mb_strlen("\n\n");        // ã‚¿ã‚°ä¸€è¦§ã®å‰å¾Œã®æ”¹è¡Œã¶ã‚“
        $count_char_pane += mb_strlen('[nn/mm]');     // å–ã‚Šã¾ã¨ã‚ã®ãƒšãƒ¼ã‚¸åˆ†å‰²è¡¨ç¤ºã¶ã‚“

        // è¨­å®šï¼šãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ã‚¿ã‚°ä¸€è¦§ã®æŠ½å‡º
        // 500æ–‡å­—ï¼ˆMAX_TOOT_CHARï¼‰åŒºåˆ‡ã‚Šã§ $msg_tags é…åˆ—ã«ã‚»ãƒƒãƒˆ
        $msg_tags = array();
        $tmp_tags = ''; // æ–‡å­—æ•°ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨
        ksort($list_tags_tooted); // ã‚¿ã‚°ä¸€è¦§ã‚’æ˜‡é †ã§ã‚½ãƒ¼ãƒˆ
        foreach ($list_tags_tooted as $tag) {
            // ç©ºç™½ã‚¿ã‚°ã¯ã‚¹ã‚­ãƒƒãƒ—
            if( empty( trim( $tag )){
                continue;
            }
            $tmp_tag          = "#${tag}\n";
            $count_char_tag   = mb_strlen($tmp_tag);
            $count_char_tags  = mb_strlen($tmp_tags);
            $count_char_tags  = $count_char_tag  + $count_char_tags;
            $count_char_total = $count_char_tags + $count_char_pane;

            if (MAX_TOOT_CHAR <= $count_char_total) {
                // MAX CHARæ•°ã‚’è¶…ãˆãŸã‚‰ã‚ªãƒ¼ãƒãƒ¼ã¶ã‚“ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦é…åˆ—ã«ã‚»ãƒƒãƒˆ
                $msg_tags[] = trim($tmp_tags);
                $tmp_tags   = '';
                $tmp_tags   = $tmp_tag;
            } else {
                $tmp_tags  .= $tmp_tag;
            }
        }
        // è¨­å®šï¼šæ®‹ã‚Šã®ã‚¿ã‚°ã‚’ã‚»ãƒƒãƒˆ
        if (! empty($tmp_tags)) {
            $msg_tags[] = trim($tmp_tags);
        }

        $denominator    = count($msg_tags); //åˆ†æ¯
        $is_tag_splited = ( 1 < $denominator );

        // 500æ–‡å­—ã”ã¨ã«å–ã‚Šã¾ã¨ã‚ã‚’ãƒˆã‚¥ãƒ¼ãƒˆ
        foreach ($msg_tags as $fraction => $tag_set) {
            echo_on_debug($msg_tags);

            if ($is_tag_splited) {
                $fraction_tmp = $fraction +1;
                $msg_additional_fraction = "[${fraction_tmp}/${denominator}]";
            } else {
                $msg_additional_fraction = '';
            }
            //
            // ã¨ã‚Šã¾ã¨ã‚ãƒˆã‚¥ãƒ¼ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹
            //----------------------------------------------------------
            $msg =<<<EOD
${msg_header}
${tag_set}
${msg_footer}
EOD;

            // è¨­å®šï¼šè¿”ä¿¡å…ˆãƒˆã‚¥ãƒ¼ãƒˆID
            $id_toot_replyto = $id_toot_current ?: $id_toot_original;

            // è¨­å®šï¼šæœ¬ç¨¼åƒã®å ´åˆã¯ 'unlisted' -> 'public' ã«å¤‰æ›´
            $visibility = (is_env_dev()) ? 'unlisted' : 'public';

            // è¨­å®šï¼šãƒˆã‚¥ãƒ¼ãƒˆã«å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’è¨­å®š
            $params = [
                'spoiler_text'   => $spoiler_text . $msg_additional_fraction,
                'status'         => $msg,
                'domain'         => $domain,
                'access_token'   => $access_token,
                'in_reply_to_id' => $id_toot_replyto,
                'visibility'     => $visibility,
            ];

            // å®Ÿè¡Œï¼šã¨ã‚Šã¾ã¨ã‚ãƒˆã‚¥ãƒ¼ãƒˆï¼ˆå­ãƒˆã‚¥ãƒ¼ãƒˆï¼‰ã®å®Ÿè¡Œ
            $result_toot = post_toot($params);

            // å–å¾—ï¼šãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ã®ãƒˆã‚¥ãƒ¼ãƒˆID
            if (TOOT_SUCCESS == $result_toot) {
                $result_toot_value = json_decode($result_toot['value'], JSON_OBJECT_AS_ARRAY);
                if (isset($result_toot_value['id'])) {
                    $id_toot_current = $result_toot_value['id'];
                } else {
                    echo_on_debug($result_toot, 'å­ãƒˆã‚¥ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ$result_toot ã®å†…å®¹ï¼‰');
                }
            } else {
                echo_on_debug($params, 'å­ãƒˆã‚¥ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ$params ã®å†…å®¹ï¼‰');
            }
        }
    } // EOF å®£è¨€å‰ã®ã€Œå–ã‚Šã¾ã¨ã‚ã€ãƒˆã‚¥ãƒ¼ãƒˆ

    // -----------------------------------------------------------------
    //  å®£è¨€å‰ãƒˆã‚¥ãƒ¼ãƒˆ
    // -----------------------------------------------------------------

    // åˆæœŸåŒ–ï¼šãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ã‚¿ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    $list_tags_tooted = array();

    // ç¾åœ¨ã®æ—¥æ™‚ã‚’è¨­å®š
    $date_today  = date('Y/m/d');
    $date_hour24 = date('H');
    $date_hour12 = (integer) date('h');
    // æ™‚å ±ç”¨ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©
    $icon_hour = strtr($date_hour12, [
        12 => 'ğŸ•›', 11 => 'ğŸ•š', 10 => 'ğŸ•™', 9 => 'ğŸ•˜',
        8  => 'ğŸ•—',  7 => 'ğŸ•–',  6 => 'ğŸ••', 5 => 'ğŸ•”',
        4  => 'ğŸ•“',  3 => 'ğŸ•’',  2 => 'ğŸ•‘', 1 => 'ğŸ•',
        0  => 'ğŸ•›',
    ]);

    //
    // CWæ–‡ï¼ˆ$spoiler_textï¼‰
    // -----------------------------------------------------------------
    $spoiler_text =<<<EOD
${icon_hour} ${date_hour24} æ™‚ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ :qiitan: (${date_today})
EOD;

    // DEVç’°å¢ƒã®å ´åˆã®ä»˜åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    $msg_additional = (is_env_dev()) ? "[#Qithub:DEV]\n" : '';

    //
    // æœ¬æ–‡ï¼ˆå®£è¨€ãƒˆã‚¥ãƒ¼ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ï¼‰
    // -----------------------------------------------------------------
    $msg =<<<EOD
â–â–â–â–â–â–â–â–â–â–
:qiita: æ–°ç€è¨˜äº‹ã®ç´¹ä»‹ã‚’é–‹å§‹ã—ã¾ã™
â–â–â–â–â–â–â–â–â–â–

Qiitadon ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–°è¦ Qiita è¨˜äº‹ã‚’ã€ã“ã®ãƒˆã‚¥ãƒ¼ãƒˆã«ã€Œæœªåè¼‰ã€ã§è¿”ä¿¡ã—ã¦ã„ãã‚ˆã€‚

æ®‹ã‚Šã®è¨˜äº‹ã¯ã€Œéå…¬é–‹ã€ã§è¿”ä¿¡ã—ã¦ã„ã‚‹ã®ã§èˆˆå‘³ãŒã‚ã‚‹äººã¯ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã­ã€‚

${msg_additional}
EOD;

    // æœ¬ç¨¼åƒã®å ´åˆã¯ 'unlisted' -> 'public' ã«å¤‰æ›´
    $visibility = (is_env_dev()) ? 'unlisted' : 'public';

    // ãƒˆã‚¥ãƒ¼ãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šï¼ˆæ–°è¦æŠ•ç¨¿ï¼‰
    $params = [
        'spoiler_text' => $spoiler_text,
        'status'       => $msg,
        'domain'       => $domain,
        'access_token' => $access_token,
        'visibility'   => $visibility,
    ];

    // å®Ÿè¡Œï¼šå®£è¨€ãƒˆã‚¥ãƒ¼ãƒˆã‚’ãƒã‚¹ãƒˆ
    $result_toot = post_toot($params);

    // å–å¾—ï¼šç„¡äº‹ãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ã®ãƒˆã‚¥ãƒ¼ãƒˆIDï¼ˆè¦ªãƒˆã‚¥ãƒ¼ãƒˆ:original, ç›´è¿‘ãƒˆã‚¥ãƒ¼ãƒˆ:currentï¼‰
    //       ãƒˆã‚¥ãƒ¼ãƒˆã«å¤±æ•—ã—ãŸå ´åˆã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ç¶™ç¶š
    if (TOOT_SUCCESS == $result_toot) {
        $result_toot_value = json_decode($result_toot['value'], JSON_OBJECT_AS_ARRAY);
        if (isset($result_toot_value['id'])) {
            $id_toot_original = $result_toot_value['id'];
            $id_toot_current  = $id_toot_original;
            $is_new_toot = false;
        } else {
            $debug_title = debug_msg('å®£è¨€ï¼ˆè¦ªãƒˆã‚¥ãƒ¼ãƒˆï¼‰ã®ãƒˆã‚¥ãƒ¼ãƒˆIDå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            echo_on_debug($result_toot, $debug_title);
            $is_new_toot = true; //ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹ã—ãªã„
            $id_thread   = $id_thread_last; //ã‚¹ãƒ¬ãƒƒãƒ‰IDã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
        }
    } else {
        $debug_title = debug_msg('å®£è¨€ï¼ˆè¦ªãƒˆã‚¥ãƒ¼ãƒˆï¼‰ã®ãƒˆã‚¥ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', true);
        echo_on_debug($result_toot, $debug_title);
        $is_new_toot = true; //ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹ã—ãªã„
        $id_thread   = $id_thread_last; //ã‚¹ãƒ¬ãƒƒãƒ‰IDã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    }
}

// ---------------------------------------------------------------------
//  æ–°ç€Qiitaè¨˜äº‹ãƒˆã‚¥ãƒ¼ãƒˆï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ã®å­ãƒˆã‚¥ãƒ¼ãƒˆï¼‰
// ---------------------------------------------------------------------
// è¦ªãƒˆã‚¥ãƒ¼ãƒˆã‚’å…ƒã«è¿”ä¿¡ã§æ–°ç€ã‚’ãƒˆã‚¥ãƒ¼ãƒˆã—ã¦ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã—ã¦ã„ãã€‚è¿”ä¿¡ã¯ï¼‘ã¤
// å‰ã®ãƒˆã‚¥ãƒ¼ãƒˆã«å¯¾ã—ã¦è¡Œã†ã€‚
// Qiitaè¨˜äº‹ã®ã‚¿ã‚°ã«ã€Œãƒ†ã‚¹ãƒˆã€ã‚„ã€Œtestã€ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã€‚
//
// ãƒ¡ãƒ¢ï¼šæœ¬ç¨¼åƒã®å ´åˆã€'visibility' ã¯ä»¥ä¸‹ã®æŒ™å‹•ã«ãªã‚‹äºˆå®š
//          åˆãƒˆã‚¥ãƒ¼ãƒˆï¼špublic
//
if (! $is_new_toot && ! empty($id_toot_current) && ! empty($qiita_items_diff)) {
    // ãƒ«ãƒ¼ãƒ—ï¼šæ–°ç€ã®å·®åˆ†ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ãƒˆã‚¥ãƒ¼ãƒˆ
    foreach ($qiita_items_diff as $item) {
        // åˆæœŸåŒ–ï¼šQiitaè¨˜äº‹ã®æƒ…å ±ä»£å…¥ã¨åˆæœŸåŒ–
        $item_title   = $item['title'];
        $item_url     = $item['url'];
        $item_tags    = '';
        $is_item_test = false;

        // ã‚¹ã‚­ãƒƒãƒ—ï¼šã‚¿ã‚¤ãƒˆãƒ«ãŒãƒ†ã‚¹ãƒˆè¨˜äº‹ãªã‚‰ã“ã®è¨˜äº‹ã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (is_title_test($item_title)) {
            continue;
        }

        // Qiitaè¨˜äº‹ã®ã‚¿ã‚°ã«ãƒ†ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ãŸå ´åˆã®ã‚¿ã‚°ã®ä¸€æ™‚çš„ãªè¿½åŠ ç”¨
        // $list_tags_tooted ã¯ã€ã¨ã‚Šã¾ã¨ã‚ãƒˆã‚¥ãƒ¼ãƒˆã®ã‚¿ã‚°ä¸€è¦§
        $list_tags_tooted_tmp = $list_tags_tooted;

        // æŠ½å‡ºï¼šQiitaè¨˜äº‹ã®ã‚¿ã‚°ï¼ˆãƒˆã‚¥ãƒ¼ãƒˆã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ç”¨ï¼‰
        foreach ($item['tags'] as $tag) {
            $tag_name = (string) $tag['name'];

            // ä¸€æ™‚è¿½åŠ ï¼šãƒˆã‚¥ãƒ¼ãƒˆå†…ã«å«ã‚ã‚‹ã‚¿ã‚°ã€‚ã‚«ãƒ³ãƒä»˜ãã®ã‚¿ã‚°ã‚‚å‡¦ç†ã€‚
            if (strpos($tag_name, ',')) {
                $tmp_tags = explode(',', $tag_name);
                foreach ($tmp_tags as $tmp_tag) {
                    $tmp_tag    = sanitize_tag_for_qiitadon($tmp_tag);
                    $item_tags .= "#${tmp_tag} ";
                    $list_tags_tooted_tmp[] = strtolower($tmp_tag);
                    // ç¢ºèªï¼šQiitaè¨˜äº‹ãŒãƒ†ã‚¹ãƒˆæŠ•ç¨¿ï¼ˆã‚¿ã‚°ã«ã€Œãƒ†ã‚¹ãƒˆã€ã‚’å«ã‚€ï¼‰ã‹ç¢ºèª
                    $is_item_test = (is_tag_test($tmp_tag) && ! $is_item_test) ?: $is_item_test;
                }
            } else {
                $tmp_tag = sanitize_tag_for_qiitadon($tag_name);
                $item_tags .= "#${tmp_tag} ";
                // ç¢ºèªï¼šQiitaè¨˜äº‹ãŒãƒ†ã‚¹ãƒˆæŠ•ç¨¿ï¼ˆã‚¿ã‚°ã«ã€Œãƒ†ã‚¹ãƒˆã€ã‚’å«ã‚€ï¼‰ã‹ç¢ºèª
                $is_item_test = (is_tag_test($tmp_tag) && ! $is_item_test) ?: $is_item_test;

                $list_tags_tooted_tmp[] = strtolower($tmp_tag);
            }

            // æ•´ç†ï¼šä¿å­˜ç”¨ã®ãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ã‚¿ã‚°ä¸€è¦§ã‚’ä¸€æ„ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰ã«
            $list_tags_tooted_tmp = array_values(array_unique($list_tags_tooted_tmp));
        }

        // Qiitaè¨˜äº‹ãŒãƒ†ã‚¹ãƒˆè¨˜äº‹ã§ãªã„å ´åˆã¯ã€tempã‚¿ã‚°ä¸€è¦§ã‚’é©ç”¨
        if (! $is_item_test) {
            $list_tags_tooted = $list_tags_tooted_tmp;
        }
        $item_tags = trim($item_tags);

        // ã‚¹ã‚­ãƒƒãƒ—ï¼šãƒ†ã‚¹ãƒˆè¨˜äº‹ãªã‚‰ãƒˆã‚¥ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
        if ($is_item_test) {
            continue;
        }

        // è¿½åŠ ï¼šDEVç’°å¢ƒã®å ´åˆã®è¿½åŠ ã‚¿ã‚°
        $item_tags_additional = (is_env_dev()) ? "[#Qithub:DEV]" : '';

        //ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—
        /** @todo BOTãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã€Qiitadonãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ¤æ–­ã€‚BOTãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãªã‚‰æœªåè¼‰ */
        $id_user_qiita = sanitize_id_user_qiita($item['user']['id']);

        //è¨­å®šï¼šDEVç’°å¢ƒã®æ™‚ã¯ã‚¢ãƒƒãƒˆãƒãƒ¼ã‚¯ã‚’å…¨è§’ã«ã—ã¦ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã›ãªã„
        $atmark = (is_env_dev()) ? 'ï¼ ' : '@';

        // ä½œæˆï¼šãƒˆã‚¥ãƒ¼ãƒˆå†…å®¹
        // Qiitadonãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’å¤‰æ›´ã—ã€Boostoot
        // ãƒªãƒ³ã‚¯ã‚’ä»˜åŠ ï¼ˆissue #52ï¼‰
        //Qiitadonãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãã®ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’å¤‰ãˆã‚‹
        $url_user = "https://qiitadon.com/@${id_user_qiita}";
        if (isValid_url($url_user)) {
            $visibility = 'unlisted';

            //
            // Qiitadonãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Qiitaè¨˜äº‹ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            // ---------------------------------------------------------
            $msg =<<<EOD
ğŸ“°ã€ãŠçŸ¥ã‚‰ã›ã€‘:qiitan:

ğŸ†• ${atmark}${id_user_qiita} ã•ã‚“ãŒâ€‹#Qiitaè¨˜äº‹â€‹ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼

:qiita:â€‹ã€${item_title}ã€
${item_url}

[ ${item_tags} ]${item_tags_additional} #${id_user_qiita}
EOD;
        } else {
            $visibility = 'private';
            //
            // åŸºæœ¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆBoostoot, ä¸€èˆ¬ãƒˆã‚¥ãƒ¼ãƒˆä½µç”¨ï¼‰
            // ---------------------------------------------------------
            $msg =<<<EOD
:qiita:â€‹ã€${item_title}ã€
${item_url} by ${atmark}${id_user_qiita}

[ ${item_tags} ]${item_tags_additional} #${id_user_qiita}
EOD;

            // Boostootã®ãƒªãƒ³ã‚¯ä½œæˆ
            $msg_boostoot      = "\n\n${msg} #Boostoot of @qithub";
            $msg_link_boostoot = urlencode($msg_boostoot);

            //
            // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Qiitaè¨˜äº‹ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            // ---------------------------------------------------------
            $msg =<<<EOD
ğŸ†•ã€æ–°ç€Qiitaè¨˜äº‹ã€‘

â€‹${msg}\nBoostoot! â†’ https://qiitadon.com/share?text=${msg_link_boostoot}
EOD;
        }

        // ãƒˆã‚¥ãƒ¼ãƒˆï¼šè¿”ä¿¡ãƒˆã‚¥ãƒ¼ãƒˆï¼ˆå­ãƒˆã‚¥ãƒ¼ãƒˆï¼‰ã®å®Ÿè¡Œ
        $params = [
            'status'         => $msg,
            'domain'         => $domain,
            'access_token'   => $access_token,
            'in_reply_to_id' => $id_toot_current,
            'visibility'     => $visibility,
        ];
        $result_toot = post_toot($params);

        // å–å¾—ï¼šç„¡äº‹ãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ã®ãƒˆã‚¥ãƒ¼ãƒˆID
        if (TOOT_SUCCESS == $result_toot) {
            $result_toot_value = json_decode($result_toot['value'], JSON_OBJECT_AS_ARRAY);
            if (isset($result_toot_value['id'])) {
                $id_toot_current = $result_toot_value['id'];
            } else {
                echo_on_debug($result_toot, 'å­ãƒˆã‚¥ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ$result_tootã®å†…å®¹ï¼‰');
            }
        } else {
            echo_on_debug("å­ãƒˆã‚¥ãƒ¼ãƒˆã®ãƒˆã‚¥ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n", 'Toot fail');
        }
    }
}

// ---------------------------------------------------------------------
//  ä¿å­˜ï¼šãƒˆã‚¥ãƒ¼ãƒˆçµæœã®è¡¨ç¤ºã¨ãƒˆã‚¥ãƒ¼ãƒˆIDï¼†ä»Šæ—¥ã®æ—¥ä»˜ã‚’ä¿å­˜
// ---------------------------------------------------------------------
if (TOOT_SUCCESS == $result_toot) {
    // å–å¾—ï¼šå­ãƒˆã‚¥ãƒ¼ãƒˆIDã®å–å¾—
    //$id_toot_current = json_decode($result_toot['value'], JSON_OBJECT_AS_ARRAY)['id'];

    // ä¿å­˜ï¼š$info_toot_to_saveï¼ˆæ™‚é–“ã€è¦ªãƒˆã‚¥ãƒ¼ãƒˆIDã€æœ€çµ‚ãƒˆã‚¥ãƒ¼ãƒˆIDï¼‰
    $info_toot_to_save = [
        'id_thread'        => $id_thread,
        'id_toot_original' => $id_toot_original,
        'id_toot_current'  => $id_toot_current,
    ];
    $result_save = save_data($id_data_toot, $info_toot_to_save);
    if (SAVE_DATA_SUCCESS == $result_save) {
        echo 'Toot info saved.' . BR_EOL;
    }

    // ä¿å­˜ï¼šãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿Qiitaè¨˜äº‹ä¸€è¦§
    $result_save = save_data($id_data_qiita, $qiita_items_new);
    if (SAVE_DATA_SUCCESS == $result_save) {
        echo 'Qiita info saved.' . BR_EOL;
    }

    // ä¿å­˜ï¼šãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ã‚¿ã‚°ä¸€è¦§
    $result_save = save_data($id_data_tags, $list_tags_tooted);
    if (SAVE_DATA_SUCCESS == $result_save) {
        echo 'Tag list saved.' . BR_EOL;
    }
} else {
    echo 'Toot fail.' . BR_EOL;
    if (empty($qiita_items_diff)) {
        echo 'There is no diffs on tooted items. Did not toot.' . BR_EOL;
    } else {
        echo 'ãƒˆã‚¥ãƒ¼ãƒˆã«å¤±æ•—ã—ãŸãƒˆã‚¥ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚' . BR_EOL;
    }

    if (is_env_dev()) {
        echo '<hr>';
        echo_on_debug($id_thread, 'ThreadID');
        echo_on_debug($info_toot, 'TOOT INFO');
        echo ($is_new_toot) ? 'IS NEW TOOT' . BR_EOL : 'IS THREAD' . BR_EOL;
        echo (empty($id_toot_current)) ? 'CURRENT TOOT ID EMPTY' . BR_EOL : "CUR ID:${id_toot_current}" . BR_EOL;
        echo (empty($qiita_items_diff)) ? 'NO DIFFs' . BR_EOL : 'THERE ARE DIFFs' . BR_EOL;
    }
}

// ç¢ºèªï¼šãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®æ–°ç€Qiitaè¨˜äº‹ã®å·®åˆ†ç¢ºèªç”¨
if (is_mode_debug()) {
    echo '<hr>';
    echo_on_debug($qiita_items_new, 'New item');
    echo_on_debug($qiita_items_old, 'Old item');
    echo_on_debug($qiita_items_diff, 'Diff item');
    echo_on_debug($info_toot, 'TOOT INFO');
}
