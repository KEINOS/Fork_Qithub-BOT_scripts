<?php
// ãƒ—ãƒ­ã‚»ã‚¹ 'toot-daily-qiita-items'
// -------------------------------------------------------------
// æ—¥ä»˜ã”ã¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§æ–°ç€Qiitaè¨˜äº‹ã‚’ãƒˆã‚¥ãƒ¼ãƒˆã™ã‚‹
//
// 'toot-daily' ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ–°ç€Qiitaè¨˜äº‹ã®ãƒˆã‚¥ãƒ¼ãƒˆã«ã‚«ã‚¹ã‚¿ãƒ ã—ãŸ
// ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã€‚

// åˆæœŸåŒ–
$result_toot = TOOT_FAIL;

// ãƒˆã‚¥ãƒ¼ãƒˆã«å¿…è¦ãªAPIã®å–å¾—
$keys_api     = get_api_keys('../../qithub.conf.json', 'qiitadon');
$domain       = $keys_api['domain'];
$access_token = ACCESS_TOKEN_MASTODON;

// ãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ã®ãƒˆã‚¥ãƒ¼ãƒˆIDã¨ãƒˆã‚¥ãƒ¼ãƒˆæ—¥ã®èª­ã¿è¾¼ã¿
$id_data_toot = 'toot_id_and_date_of_daily_toot';
$info_toot    = load_data($id_data_toot);

// ãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ã®æ–°ç€Qiitaè¨˜äº‹ã®èª­ã¿è¾¼ã¿
$id_data_qiita   = 'qiita_id_tooted';
$qiita_items_old = load_data($id_data_qiita);
$qiita_items_old = ( $qiita_items_old == LOAD_DATA_EMPTY ) ? array() : $qiita_items_old;

// å‹•ä½œç¢ºèªç”¨ã®è¦ç´ ã®å‰Šé™¤
//unset($qiita_items_old['9412acb2a7ff37ff9ad0']);

// æœ€æ–°ã®æ–°ç€Qiitaè¨˜äº‹ã®å–å¾—ã¨ãƒˆã‚¥ãƒ¼ãƒˆæ¸ˆã¿ã®æ¯”è¼ƒï¼ˆå·®åˆ†å–å¾—ï¼‰
$max_items  = 10;
$result_api = run_script(
    'system/get-qiita-new-items',
    ['max_items' => $max_items],
    false
);
$qiita_items_new  = decode_api_to_array($result_api)['value'];
$qiita_items_diff = array_diff_key($qiita_items_new, $qiita_items_old);

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®æ–°ç€Qiitaè¨˜äº‹ã®å·®åˆ†ç¢ºèªç”¨
if (is_mode_debug()) {
    echo_on_debug($qiita_items_new, 'New item');
    echo_on_debug($qiita_items_old, 'Old item');
    echo_on_debug($qiita_items_diff, 'Diff item');
}

// ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒˆã‚¥ãƒ¼ãƒˆæ—¥ã®IDã¨ã—ã¦å–å¾—
$id_date = (int) date('YmdH');

// ãƒˆã‚¥ãƒ¼ãƒˆIDã®åˆæœŸåŒ–
$id_toot_current  = ''; // ï¼‘ã¤å‰ã®ãƒˆã‚¥ãƒ¼ãƒˆID
$id_toot_original = ''; // è¦ªã®ãƒˆã‚¥ãƒ¼ãƒˆID

// æœ¬æ—¥ã®åˆãƒˆã‚¥ãƒ¼ãƒˆãŒç™ºå‹•æ¸ˆã¿ã‹ã®ãƒ•ãƒ©ã‚°è¨­å®š
// ç™ºå‹•æ¸ˆã¿ã®å ´åˆã€è¦ªãƒˆã‚¥ãƒ¼ãƒˆã¨æœ€æ–°ï¼ˆï¼‘ã¤å‰ã®ï¼‰ãƒˆã‚¥ãƒ¼ãƒˆã‚’å–å¾—
if ($info_toot !== LOAD_DATA_EMPTY) {
    // æœ¬æ—¥ã®åˆãƒˆã‚¥ãƒ¼ãƒˆãƒ•ãƒ©ã‚°ï¼ˆä¿å­˜æ—¥ã®æ¯”è¼ƒï¼‰
    $is_new_toot = ($info_toot['id_date'] !== $id_date);
    // ãƒˆã‚¥ãƒ¼ãƒˆIDã®å–å¾—
    $id_toot_current  = $info_toot['id_toot_current'];
    $id_toot_original = $info_toot['id_toot_original'];
} else {
    // æœ¬æ—¥ã®åˆãƒˆã‚¥ãƒ¼ãƒˆãƒ•ãƒ©ã‚°
    $is_new_toot = true;
}

// æ–°ç€Qiitaè¨˜äº‹ãƒˆã‚¥ãƒ¼ãƒˆã®é–‹å§‹å®£è¨€å®Ÿè¡Œï¼ˆè¦ªãƒˆã‚¥ãƒ¼ãƒˆï¼‰
//
// æœ¬æ—¥åˆã®ãƒˆã‚¥ãƒ¼ãƒˆãŒæœªç™ºä¿¡ã®å ´åˆã¯ã€å®£è¨€ãƒˆã‚¥ãƒ¼ãƒˆã‚’ç™ºä¿¡ã€‚
// è¦ªãƒˆã‚¥ãƒ¼ãƒˆã¨ç›´è¿‘ãƒˆã‚¥ãƒ¼ãƒˆã®IDã‚’è¨­å®š
// æœ¬ç¨¼åƒã®å ´åˆã€'visibility' ã¯ä»¥ä¸‹ã®æŒ™å‹•ã«ãªã‚‹
//    åˆãƒˆã‚¥ãƒ¼ãƒˆï¼špublic
//
if ($is_new_toot) {
    // ãƒˆã‚¥ãƒ¼ãƒˆå†…å®¹ã®ä½œæˆ
    $date_today = date('Y/m/d Hæ™‚');
    // CWæ–‡
    $spoiler_text = "${date_today} ã®æ–°ç€Qiitaè¨˜äº‹ã®ãƒˆã‚¥ãƒ¼ãƒˆã‚’å§‹ã‚ã‚‹ã‚ˆï¼";
    // DEVç’°å¢ƒã®å ´åˆã®ä»˜åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    $msg_additional = (is_env_dev()) ? "[#Qithub:DEV]\n" : '';
    // æœ¬æ–‡
    $msg =<<<EOL
ã“ã®ãƒˆã‚¥ãƒ¼ãƒˆã«ã€Œéå…¬é–‹ã€ã§ãƒˆã‚¥ãƒ¼ãƒˆã—ã¦ã„ãã‹ã‚‰ã€èˆˆå‘³ãŒã‚ã‚‹äººã¯ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã­ã€‚

ãŸã ã€Qiitadon ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® Qiita è¨˜äº‹ã ã£ãŸå ´åˆã¯ã€Œæœªåè¼‰ã€ã§ãƒˆã‚¥ãƒ¼ãƒˆã™ã‚‹ã‚ˆã€‚

ã‚‚ã—ã€ãƒˆã‚¥ãƒ¼ãƒˆã« ğŸ”ƒï¼ˆãƒ–ãƒ¼ã‚¹ãƒˆï¼‰ã‚„ â­ï¸ï¼ˆãŠæ°—ã«å…¥ã‚Šï¼‰ãŒä¸€å®šæ•°ã¤ã„ãŸå ´åˆã¯ã€Œå…¬é–‹ã€ã§æ”¹ã‚ã¦ ãŠã™ã™ã‚ãƒˆã‚¥ãƒ¼ãƒˆ ã—ã¦ã€Qiitaè¨˜äº‹ã®æ–¹ã«ã‚‚ã€Œã„ã„ã­ï¼ã€ã™ã‚‹ã‹ã‚‰ã€æ°—ã«ã„ã£ãŸè¨˜äº‹ã®ãƒˆã‚¥ãƒ¼ãƒˆã ã£ãŸã‚‰ ğŸ”ƒ â­ï¸ ã—ã¦çŸ¥ã‚‰ã›ã¦ã­ï¼${msg_additional}
EOL;
    // æœ¬ç¨¼åƒã®å ´åˆã¯ 'unlisted' -> 'public' ã«å¤‰æ›´
    $visibility = 'unlisted';

    // ãƒˆã‚¥ãƒ¼ãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šï¼ˆæ–°è¦æŠ•ç¨¿ï¼‰
    $params = [
        'status'       => $msg,
        'spoiler_text' => $spoiler_text,
        'domain'       => $domain,
        'access_token' => $access_token,
        'visibility'   => $visibility,
    ];
    // ãƒˆã‚¥ãƒ¼ãƒˆã®å®Ÿè¡Œ
    $result_toot = post_toot($params);

    if ($result_toot == TOOT_SUCCESS) {
        $is_new_toot = false;
        // è¦ªãƒˆã‚¥ãƒ¼ãƒˆãƒ»ç›´è¿‘ãƒˆã‚¥ãƒ¼ãƒˆã®IDè¨­å®š
        $id_toot_original = json_decode($result_toot['value'], JSON_OBJECT_AS_ARRAY)['id'];
        $id_toot_current  = $id_toot_original;
    }
}

// æ–°ç€Qiitaè¨˜äº‹ã®ãƒˆã‚¥ãƒ¼ãƒˆé–‹å§‹ï¼ˆå­ãƒˆã‚¥ãƒ¼ãƒˆï¼‰
//
// è¦ªãƒˆã‚¥ãƒ¼ãƒˆã‚’å…ƒã«ã‚¹ãƒ¬ãƒƒãƒ‰ã§æ–°ç€ã‚’ãƒˆã‚¥ãƒ¼ãƒˆã—ã¦ã„ãã€‚è¿”ä¿¡ã¯ï¼‘ã¤å‰ã®ãƒˆã‚¥ãƒ¼
// ãƒˆã€Qiitaè¨˜äº‹ã®ã‚¿ã‚°ã«ã€Œãƒ†ã‚¹ãƒˆã€ã‚„ã€Œtestã€ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã€‚
//
// æœ¬ç¨¼åƒã®å ´åˆã€'visibility' ã¯ä»¥ä¸‹ã®æŒ™å‹•ã«ãªã‚‹
//    åˆãƒˆã‚¥ãƒ¼ãƒˆï¼špublic
if (! $is_new_toot && ! empty($id_toot_current) && ! empty($qiita_items_diff)) {
    // æ–°ç€ã®å·®åˆ†ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ãƒˆã‚¥ãƒ¼ãƒˆ
    foreach ($qiita_items_diff as $item) {
        // Qiitaè¨˜äº‹ã®æƒ…å ±ä»£å…¥ã¨åˆæœŸåŒ–
        $item_title   = $item['title'];
        $item_url     = $item['url'];
        $item_tags    = '';
        $is_item_test = false;

        foreach ($item['tags'] as $tag) {
            $s = (string) $tag['name'];
            $s = str_replace('++', 'ãƒ—ãƒ©ãƒ—ãƒ©', $s);
            $s = str_replace('#', 'Sharp', $s);
            $s = str_replace('.', '', $s);
            $s = str_replace('-', '_', $s);
            $s = trim($s);

            // ã‚¿ã‚°ã®è¿½åŠ 
            $item_tags .= "#${s} ";

            // Qiitaè¨˜äº‹ãŒãƒ†ã‚¹ãƒˆæŠ•ç¨¿ï¼ˆã‚¿ã‚°ã«ã€Œãƒ†ã‚¹ãƒˆã€ã‚’å«ã‚€ï¼‰ã‹ç¢ºèª
            $is_item_test = (is_tag_test($s) && ! $is_item_test) ?: $is_item_test;
        }

        // ãƒ†ã‚¹ãƒˆè¨˜äº‹ãªã‚‰ãƒˆã‚¥ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
        if ($is_item_test) {
            continue;
        }

        $item_tags = trim($item_tags);

        // DEVç’°å¢ƒã®å ´åˆã«ã¯ã‚¿ã‚°ã«è¿½åŠ 
        $item_tags_additional = (is_env_dev()) ? "[#Qithub:DEV]" : '';

        // ãƒˆã‚¥ãƒ¼ãƒˆå†…å®¹ã®ä½œæˆ
        // Qiitadonãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’å¤‰æ›´
        //
        /** @todo BOTãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã€Qiitadonãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ¤æ–­
                  BOTãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãªã‚‰æœªåè¼‰ */
        $id_user_qiita = sanitize_id_user_qiita($item['user']['id']);
        $url_user = "https://qiitadon.com/@${id_user_qiita}";
        if (isValid_url($url_user)) {
            $visibility = 'unlisted';
            $msg ="ã€ãŠçŸ¥ã‚‰ã›ã€‘\n@${id_user_qiita} ã•ã‚“ãŒ #Qiitaè¨˜äº‹ ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼\n\nğŸ†•ã€${item_title}ã€\n${item_url}\n\n[${item_tags}]${item_tags_additional}";
        } else {
            $visibility = 'private';
            $msg = "ã€${item_title}ã€ @${id_user_qiita}\n${item_url}\n\n[${item_tags}]${item_tags_additional}";
            $msg_link_boostoot = urlencode("ğŸ†• #Qiitaè¨˜äº‹\n\n${msg} #Boostoot of @Qithub");
            $msg = "ğŸ†•ã€æ–°ç€Qiitaè¨˜äº‹ã€‘\n\n${msg}\nBoostoot! â†’ https://qiitadon.com/share?text=${msg_link_boostoot}";
        }
        
        // è¿”ä¿¡ãƒˆã‚¥ãƒ¼ãƒˆã®å®Ÿè¡Œ
        $params = [
            'status'         => $msg,
            'domain'         => $domain,
            'access_token'   => $access_token,
            'in_reply_to_id' => $id_toot_current,
            'visibility'     => $visibility,
        ];
        $result_toot = post_toot($params);

        if ($result_toot == TOOT_SUCCESS) {
            // ãƒˆã‚¥ãƒ¼ãƒˆIDã®å–å¾—
            $id_toot_current = json_decode($result_toot['value'], JSON_OBJECT_AS_ARRAY)['id'];
        }
    }
}

// ãƒˆã‚¥ãƒ¼ãƒˆçµæœã®è¡¨ç¤ºã¨ãƒˆã‚¥ãƒ¼ãƒˆIDï¼†ä»Šæ—¥ã®æ—¥ä»˜ã‚’ä¿å­˜
if ($result_toot == TOOT_SUCCESS) {
    // ãƒˆã‚¥ãƒ¼ãƒˆIDã®å–å¾—
    //$id_toot_current = json_decode($result_toot['value'], JSON_OBJECT_AS_ARRAY)['id'];
    // ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
    $info_toot_to_save = [
        'id_toot_current'  => $id_toot_current,
        'id_toot_original' => $id_toot_original,
        'id_date'          => $id_date,
    ];
    // ä»Šå›ã®ãƒˆã‚¥ãƒ¼ãƒˆIDã®ä¿å­˜ï¼ˆè¿”ä¿¡ã®å ´åˆã¯ãƒ‡ã‚¤ã‚¸ãƒ¼ãƒã‚§ãƒ¼ãƒ³ï¼‰
    $result_save = save_data($id_data_toot, $info_toot_to_save);
    if ($result_save == SAVE_DATA_SUCCESS) {
        echo 'Toot info saved.' . BR_EOL;
    }
    // ä»Šå›ã®ãƒˆã‚¥ãƒ¼ãƒˆIDã®ä¿å­˜ï¼ˆè¿”ä¿¡ã®å ´åˆã¯ãƒ‡ã‚¤ã‚¸ãƒ¼ãƒã‚§ãƒ¼ãƒ³ï¼‰
    $result_save = save_data($id_data_qiita, $qiita_items_new);
    if ($result_save == SAVE_DATA_SUCCESS) {
        echo 'Qiita info saved.' . BR_EOL;
    }
} else {
    echo 'Toot fail.' . BR_EOL;
    if (empty($qiita_items_diff)) {
        echo 'There is no diffs on tooted items. Did not toot.' . BR_EOL;
    }
}
